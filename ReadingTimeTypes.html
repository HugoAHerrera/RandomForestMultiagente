<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pruebas de lectura CSV</title>
</head>
<body>
  <h2>Seleccion√° un CSV grande</h2>
  <input type="file" id="csvFile" accept=".csv"><br><br>

  <button onclick="opcion1()">Opci√≥n 1: Lectura b√°sica cada 10k l√≠neas</button>
  <button onclick="opcion2()">Opci√≥n 2: Web Workers simulados (paralelo)</button>
  <button onclick="opcion3()">Opci√≥n 3: Env√≠o simulado por lotes</button>
  <button onclick="opcion4()">Opci√≥n 4: Stream().getReader() y TextDecoder</button>

  <script>
    function opcion1() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Sub√≠ un archivo primero.");

        const chunkSize = 1024 * 1024; // 1MB
        let offset = 0;
        let count = 0;
        let leftover = '';
        const start = performance.now();

        function readChunk() {
        if (offset >= file.size) {
            const end = performance.now();
            console.log(`‚úÖ Lectura completada en ${(end - start).toFixed(2)} ms`);
            return;
        }

        const slice = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();

        reader.onload = function (e) {
            let text = leftover + e.target.result;
            let lines = text.split(/\r?\n/);
            leftover = lines.pop(); // la √∫ltima l√≠nea puede estar incompleta

            for (let i = 0; i < lines.length; i++) {
            count++;
            if (count % 10000 === 0) {
                console.log(`üü® Simulando env√≠o de 10k l√≠neas (total: ${count})`);
            }
            }

            offset += chunkSize;
            console.log(`üì¶ Procesado hasta byte ${offset}...`);
            setTimeout(readChunk, 0); // evitar bloquear la UI
        };

        reader.onerror = function (e) {
            console.error("‚ùå Error leyendo archivo:", e);
        };

        reader.readAsText(slice);
        }

        readChunk();
    }

    function opcion2() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return alert("Sub√≠ un archivo primero.");

      const start = performance.now();
      const chunkSize = 500000; // bytes
      const numWorkers = 4;
      let offset = 0;
      let workersDone = 0;

      const workers = [];
      for (let i = 0; i < numWorkers; i++) {
        const worker = new Worker(URL.createObjectURL(new Blob([`
          self.onmessage = function(e) {
            const text = e.data;
            const lines = text.split(/\\r?\\n/);
            console.log("Simulando env√≠o de", lines.length, "l√≠neas desde worker");
            self.postMessage("done");
          }
        `], { type: 'application/javascript' })));

        worker.onmessage = function () {
          workersDone++;
          if (workersDone === Math.ceil(file.size / chunkSize)) {
            const end = performance.now();
            console.log(`‚úÖ Opci√≥n 2 completada en ${(end - start).toFixed(2)} ms`);
          }
        };

        workers.push(worker);
      }

      while (offset < file.size) {
        const chunk = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();
        const currentWorker = workers[offset % numWorkers];

        reader.onload = function(e) {
          currentWorker.postMessage(e.target.result);
        };

        reader.readAsText(chunk);
        offset += chunkSize;
      }
    }

    function opcion3() {
    const file = document.getElementById('csvFile').files[0];
    if (!file) return alert("Sub√≠ un archivo primero.");

    const chunkSize = 1024 * 1024; // 1MB
    let offset = 0;
    let leftover = '';
    let batch = [];
    let currentAgentIndex = 0;
    const agents = ['http://agent1.com', 'http://agent2.com', 'http://agent3.com'];

    const start = performance.now();

    function sendToAgent(data, agentUrl) {
      // Simulaci√≥n del env√≠o
      console.log(`üöÄ Enviando ${data.length} l√≠neas a ${agentUrl}`);
    }

    function readChunk() {
        if (offset >= file.size) {
            if (batch.length > 0) {
            sendToAgent(batch, agents[currentAgentIndex]);
            }
            const end = performance.now();
            console.log(`‚úÖ Opci√≥n 3 completada en ${(end - start).toFixed(2)} ms`);
            return;
        }

        const slice = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();

        reader.onload = function (e) {
            let text = leftover + e.target.result;
            let lines = text.split(/\r?\n/);
            leftover = lines.pop(); // Por si qued√≥ incompleta

            for (let i = 0; i < lines.length; i++) {
            batch.push(lines[i]);
            if (batch.length === 2000) {
                sendToAgent(batch, agents[currentAgentIndex]);
                batch = [];
                currentAgentIndex = (currentAgentIndex + 1) % agents.length;
            }
            }

            offset += chunkSize;
            console.log(`üì¶ Le√≠do hasta byte ${offset}`);
            setTimeout(readChunk, 0);
        };

        reader.onerror = function (e) {
            console.error("‚ùå Error leyendo archivo:", e);
        };

        reader.readAsText(slice);
        }

        readChunk();
    }

    async function opcion4() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Sub√≠ un archivo primero.");

        const start = performance.now();
        const reader = file.stream().getReader();
        const decoder = new TextDecoder("utf-8");
        let leftover = '';
        let count = 0;

        while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        let chunk = decoder.decode(value, { stream: true });
        let lines = (leftover + chunk).split(/\r?\n/);
        leftover = lines.pop(); // l√≠nea incompleta

        for (let i = 0; i < lines.length; i++) {
            count++;
            if (count % 10000 === 0) {
            console.log(`üöÄ Simulando env√≠o de 10k l√≠neas (total: ${count})`);
            }
        }

        console.log(`üì¶ Procesado hasta l√≠nea ${count}`);
        }

        if (leftover) {
        count++;
        console.log(`üöÄ Enviando √∫ltima l√≠nea. Total: ${count}`);
        }

        const end = performance.now();
        console.log(`‚úÖ Opci√≥n 4 completada en ${(end - start).toFixed(2)} ms`);
    }
  </script>
</body>
</html>
